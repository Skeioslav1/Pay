<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pay with Paystack</title>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding-top: 60px;
    }
  </style>
</head>
<body>
  <h2>Initiating Payment...</h2>

  <script>
    (async function () {
      const query = new URLSearchParams(window.location.search);
      const ref = query.get("ref");

      if (!ref) {
        alert("Missing reference ID.");
        return;
      }

      // ✅ Step 1: Retrieve payment data from Cloudflare Worker (KV)
      const dataRes = await fetch("https://paystack-access-code.alexskeioslav.workers.dev/get?ref=" + ref);
      if (!dataRes.ok) {
        alert("Failed to load payment data.");
        return;
      }

      const data = await dataRes.json();

      const {
        email,
        Plan_Name,
        Plan_Cost,
        Plan_Expiry,
        abbreviation,
        Country
      } = data;

      if (!email || !Plan_Cost) {
        alert("Missing required payment fields.");
        return;
      }

      // ✅ Step 2: Launch Paystack payment UI
      PaystackPop.setup({
        key: 'pk_live_d4f57287975b08a2f8f84538fe5f16a5bde44286',
        email: email,
        amount: parseFloat(Plan_Cost.replace(/[^\d.]/g, "")) * 100, // Convert "Ksh 5500" → 550000
        currency: "KES",
        ref: ref,
        onClose: function () {
          alert("Payment window closed.");
        },
        callback: function (response) {
          const paidAt = new Date().toISOString();

          // ✅ Step 3: Send confirmation to subscription handler
          fetch("https://omp-subscription-handler.alexskeioslav.workers.dev/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: email,
              Plan_Name: Plan_Name,
              Plan_Cost: Plan_Cost,
              Plan_Expiry: Plan_Expiry,
              abbreviation: abbreviation,
              Country: Country,
              paid_at: paidAt,
              transactionId: response.reference
            }),
          }).then(() => {
            alert("✅ Payment successful! You may now return to the app.");
          }).catch(() => {
            alert("Payment succeeded");
          });
        }
      }).openIframe();
    })();
  </script>
</body>
</html>
